services:
  app:
    container_name: glyx-mcp
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
    ports:
      - "8080:8080"
    env_file:
      - .env
    environment:
      # AI Provider Keys
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      # Supabase
      - SUPABASE_URL=${SUPABASE_URL:-}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY:-}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY:-}
      # Memory
      - MEM0_API_KEY=${MEM0_API_KEY:-}
      # Observability
      - LOGFIRE_TOKEN=${LOGFIRE_TOKEN:-}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      # Server
      - PORT=8080
    volumes:
      - .:/app
      - /app/.venv  # Don't mount venv, use container's
      # Mount Claude credentials for authentication
      - ${HOME}/.claude/.credentials.json:/root/.claude/.credentials.json:ro
    command: uv run uvicorn api.server:combined_app --host 0.0.0.0 --port 8080 --reload
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/healthz"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3
